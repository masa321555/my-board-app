# SNS機能テスト計画書

## 1. テスト概要

### 1.1 目的
SNS機能の品質を保証し、ユーザーに安定したサービスを提供するため、包括的なテストを実施する。

### 1.2 テスト範囲
- フォロー/フォロワー機能
- タイムライン機能
- いいね機能
- コメント機能
- 通知システム
- パフォーマンス
- セキュリティ

## 2. テストの種類と優先順位

### 優先度: Critical（必須）
1. **単体テスト（Unit Tests）**
   - APIエンドポイントのロジックテスト
   - データベースモデルの検証
   - ユーティリティ関数のテスト

2. **統合テスト（Integration Tests）**
   - API間の連携テスト
   - データベーストランザクションテスト
   - 認証・認可フローのテスト

3. **セキュリティテスト**
   - 認証・認可の検証
   - SQLインジェクション対策
   - XSS対策

### 優先度: High（重要）
4. **E2Eテスト（End-to-End Tests）**
   - 主要なユーザーフローのテスト
   - クロスブラウザテスト

5. **パフォーマンステスト**
   - API応答時間の測定
   - 同時接続数のテスト
   - データベースクエリの最適化確認

### 優先度: Medium（推奨）
6. **UIテスト**
   - コンポーネントの表示テスト
   - レスポンシブデザインテスト
   - アクセシビリティテスト

7. **負荷テスト**
   - 大量データでの動作確認
   - スパイクテスト

## 3. 機能別テストケース

### 3.1 フォロー/フォロワー機能

#### API単体テスト
```typescript
describe('Follow API Tests', () => {
  test('正常系: ユーザーをフォローできる', async () => {
    // Given: 認証済みユーザーAと未フォローのユーザーB
    // When: AがBをフォロー
    // Then: フォロー関係が作成され、カウントが更新される
  });

  test('異常系: 自分自身をフォローできない', async () => {
    // Given: 認証済みユーザーA
    // When: Aが自分自身をフォロー
    // Then: エラーが返される
  });

  test('異常系: 既にフォロー済みのユーザーを再フォローできない', async () => {
    // Given: AがBを既にフォロー済み
    // When: AがBを再度フォロー
    // Then: エラーが返される
  });

  test('境界値: フォロー上限数のテスト', async () => {
    // Given: Aが上限数-1人をフォロー済み
    // When: Aが新たなユーザーをフォロー
    // Then: 成功する
    // When: さらにもう1人フォロー
    // Then: 上限エラーが返される
  });
});
```

#### 統合テスト
```typescript
describe('Follow Integration Tests', () => {
  test('フォロー時の通知生成', async () => {
    // Given: ユーザーAとB
    // When: AがBをフォロー
    // Then: Bに通知が生成される
  });

  test('相互フォローの確認', async () => {
    // Given: AがBをフォロー済み
    // When: BがAをフォロー
    // Then: 両者のフォロー状態が正しく反映される
  });

  test('プライベートアカウントのフォロー', async () => {
    // Given: Bがプライベートアカウント
    // When: AがBをフォロー
    // Then: フォローリクエストが生成される（将来実装）
  });
});
```

### 3.2 タイムライン機能

#### API単体テスト
```typescript
describe('Timeline API Tests', () => {
  test('正常系: フォロー中ユーザーの投稿を取得', async () => {
    // Given: AがB,Cをフォロー、B,Cが投稿済み
    // When: Aがタイムラインを取得
    // Then: B,Cの投稿が時系列順で返される
  });

  test('ページネーション', async () => {
    // Given: 50件の投稿
    // When: 1ページ目（20件）を取得
    // Then: 正しい20件が返される
    // When: 2ページ目を取得
    // Then: 次の20件が返される
  });

  test('フィルタリング', async () => {
    // Given: 様々な種類の投稿
    // When: 'following'フィルターで取得
    // Then: フォロー中ユーザーの投稿のみ返される
  });

  test('プライバシー設定の反映', async () => {
    // Given: 非公開投稿、フォロワー限定投稿
    // When: 権限のないユーザーがアクセス
    // Then: 表示されない
  });
});
```

#### パフォーマンステスト
```typescript
describe('Timeline Performance Tests', () => {
  test('大量フォロー時のパフォーマンス', async () => {
    // Given: 1000人をフォロー、各100投稿
    // When: タイムラインを取得
    // Then: 3秒以内にレスポンス
  });

  test('キャッシュの効果測定', async () => {
    // Given: キャッシュなしの初回アクセス
    // When: 同じリクエストを再度実行
    // Then: 2回目は50%以上高速化
  });
});
```

### 3.3 いいね機能

#### API単体テスト
```typescript
describe('Like API Tests', () => {
  test('正常系: 投稿にいいね', async () => {
    // Given: 未いいねの投稿
    // When: いいねを実行
    // Then: いいねが記録され、カウントが増加
  });

  test('正常系: いいね取り消し', async () => {
    // Given: いいね済みの投稿
    // When: いいねを取り消し
    // Then: いいねが削除され、カウントが減少
  });

  test('同時実行制御', async () => {
    // Given: 同じ投稿
    // When: 複数ユーザーが同時にいいね
    // Then: 正しくカウントされる
  });

  test('削除済み投稿へのいいね', async () => {
    // Given: 削除済みの投稿
    // When: いいねを実行
    // Then: エラーが返される
  });
});
```

### 3.4 コメント機能

#### API単体テスト
```typescript
describe('Comment API Tests', () => {
  test('正常系: コメント投稿', async () => {
    // Given: 公開投稿
    // When: コメントを投稿
    // Then: コメントが保存され、通知が生成される
  });

  test('正常系: 返信コメント', async () => {
    // Given: 既存のコメント
    // When: 返信を投稿
    // Then: 親子関係が正しく保存される
  });

  test('文字数制限', async () => {
    // Given: 1000文字のコメント
    // When: 投稿
    // Then: 成功
    // Given: 1001文字のコメント
    // When: 投稿
    // Then: エラー
  });

  test('メンション機能', async () => {
    // Given: @usernameを含むコメント
    // When: 投稿
    // Then: メンションされたユーザーに通知
  });

  test('コメントの編集権限', async () => {
    // Given: 他人のコメント
    // When: 編集を試みる
    // Then: 権限エラー
  });
});
```

### 3.5 通知システム

#### API単体テスト
```typescript
describe('Notification API Tests', () => {
  test('正常系: 通知の取得', async () => {
    // Given: 複数の未読通知
    // When: 通知一覧を取得
    // Then: 時系列順で返される
  });

  test('正常系: 既読処理', async () => {
    // Given: 未読通知
    // When: 既読にマーク
    // Then: 既読フラグが更新される
  });

  test('通知の重複防止', async () => {
    // Given: 同じアクション
    // When: 複数回実行
    // Then: 通知は1つのみ生成
  });

  test('通知設定の反映', async () => {
    // Given: いいね通知をOFF設定
    // When: いいねされる
    // Then: 通知が生成されない
  });
});
```

#### リアルタイムテスト
```typescript
describe('Realtime Notification Tests', () => {
  test('WebSocket接続', async () => {
    // Given: 認証済みユーザー
    // When: WebSocket接続
    // Then: 接続成功
  });

  test('リアルタイム通知配信', async () => {
    // Given: WebSocket接続中
    // When: 新しい通知が生成
    // Then: 即座に配信される
  });
});
```

## 4. E2Eテストシナリオ

### シナリオ1: 新規ユーザーの初期フロー
```typescript
test('新規ユーザーがフォローしてタイムラインを見る', async () => {
  // 1. ユーザー登録
  // 2. プロフィール設定
  // 3. おすすめユーザーを表示
  // 4. 3人をフォロー
  // 5. タイムラインを表示
  // 6. 投稿にいいね
  // 7. コメントを投稿
  // 8. 通知を確認
});
```

### シナリオ2: アクティブユーザーの日常フロー
```typescript
test('既存ユーザーの一般的な利用フロー', async () => {
  // 1. ログイン
  // 2. 通知バッジを確認
  // 3. タイムラインをスクロール
  // 4. 投稿にいいね・コメント
  // 5. 自分の投稿を作成
  // 6. フォロワーからの反応を確認
});
```

## 5. パフォーマンステスト

### 5.1 レスポンスタイム目標
- API応答: 95%が500ms以内
- ページロード: 3秒以内
- リアルタイム通知: 1秒以内

### 5.2 負荷テストシナリオ
```yaml
scenarios:
  - name: "通常負荷"
    users: 100
    duration: 10m
    actions:
      - timeline: 60%
      - like: 20%
      - comment: 15%
      - follow: 5%

  - name: "ピーク負荷"
    users: 1000
    duration: 5m
    ramp_up: 2m

  - name: "スパイクテスト"
    users: 0→500→0
    duration: 15m
```

## 6. セキュリティテスト

### 6.1 認証・認可
- [ ] 未認証ユーザーのアクセス制限
- [ ] 他ユーザーのプライベート情報へのアクセス防止
- [ ] トークンの有効期限チェック
- [ ] CSRF対策の確認

### 6.2 入力検証
- [ ] SQLインジェクション対策
- [ ] XSS対策（コメント、プロフィール）
- [ ] ファイルアップロードの検証
- [ ] レート制限の動作確認

### 6.3 データ保護
- [ ] パスワードのハッシュ化確認
- [ ] 機密情報のログ出力防止
- [ ] HTTPS通信の強制

## 7. テスト環境

### 7.1 必要な環境
- 開発環境: ローカルMongoDB、モックデータ
- ステージング環境: 本番相当のデータ量
- CI/CD環境: GitHub Actions

### 7.2 テストデータ
```javascript
// テストデータ生成スクリプト
const testData = {
  users: 1000,
  posts: 10000,
  comments: 50000,
  likes: 100000,
  follows: 5000,
  notifications: 20000
};
```

## 8. テスト実行計画

### Phase 1（開発中）
- 単体テスト: 各機能実装時に随時
- 統合テスト: 機能完成時

### Phase 2（統合段階）
- E2Eテスト: 全機能統合後
- パフォーマンステスト: 基本測定

### Phase 3（リリース前）
- セキュリティテスト: 専門チームによる実施
- 負荷テスト: 本番想定の負荷
- ユーザビリティテスト: ベータユーザーによる検証

### Phase 4（リリース後）
- 監視: エラー率、パフォーマンス
- A/Bテスト: 新機能の効果測定

## 9. テストツール

### 推奨ツール
- **単体テスト**: Jest, React Testing Library
- **統合テスト**: Supertest
- **E2Eテスト**: Playwright
- **パフォーマンス**: k6, Artillery
- **セキュリティ**: OWASP ZAP
- **モニタリング**: Sentry, DataDog

## 10. 合格基準

### カバレッジ目標
- 単体テスト: 80%以上
- 統合テスト: 主要フロー100%
- E2Eテスト: クリティカルパス100%

### 品質指標
- バグ密度: 1000行あたり0.5件以下
- パフォーマンス: SLA達成率99.9%
- セキュリティ: 重大な脆弱性0件