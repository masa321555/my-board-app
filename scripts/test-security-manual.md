# セキュリティテスト手順書

## 準備

1. **テスト環境の起動**
   ```bash
   npm run dev
   ```

2. **テストユーザーの作成**
   - http://localhost:3000/auth/register でテスト用アカウントを作成
   - メールアドレスとパスワードをメモしておく

3. **自動テストの実行**
   ```bash
   npm install axios jsdom isomorphic-dompurify
   node scripts/test-security.js
   ```

## 手動テストチェックリスト

### 1. レート制限テスト

#### テスト手順
1. ログイン後、掲示板の新規投稿ページへ移動
2. 1分間に6回以上投稿を作成してみる
3. 5回目まで成功、6回目でエラーが表示されることを確認

#### 確認ポイント
- [ ] 5回目までは正常に投稿できる
- [ ] 6回目で「リクエストが多すぎます」エラーが表示される
- [ ] 1分経過後、再度投稿できるようになる

### 2. XSS攻撃テスト

#### テスト手順
1. 新規投稿作成時、以下のような悪意のあるコードを入力：
   - タイトル: `<script>alert('XSS')</script>テスト`
   - 本文: `<img src=x onerror="alert('XSS')">`

2. 投稿を作成し、表示を確認

#### 確認ポイント
- [ ] スクリプトが実行されない
- [ ] HTMLタグが削除またはエスケープされている
- [ ] アラートが表示されない

### 3. CSRF防御テスト

#### テスト手順
1. ブラウザの開発者ツールを開く（F12）
2. Networkタブで投稿作成時のリクエストを確認
3. リクエストヘッダーに`X-CSRF-Token`が含まれていることを確認

#### 確認ポイント
- [ ] CSRFトークンがリクエストに含まれている
- [ ] トークンなしでAPIを直接叩くと403エラーになる

### 4. セキュリティヘッダーテスト

#### テスト手順
1. ブラウザの開発者ツールでNetworkタブを開く
2. ページをリロード
3. HTMLドキュメントのレスポンスヘッダーを確認

#### 確認ポイント
- [ ] `X-Frame-Options: DENY`
- [ ] `X-Content-Type-Options: nosniff`
- [ ] `X-XSS-Protection: 1; mode=block`
- [ ] `Content-Security-Policy`が設定されている
- [ ] `Referrer-Policy: strict-origin-when-cross-origin`

### 5. 入力値検証テスト

#### テスト手順
1. 投稿作成時に以下を試す：
   - 空のタイトル
   - 101文字以上のタイトル
   - 1001文字以上の本文

#### 確認ポイント
- [ ] 空のタイトルでエラーメッセージが表示される
- [ ] 文字数制限を超えると入力できない
- [ ] 適切なエラーメッセージが表示される

### 6. 権限管理テスト

#### テスト手順
1. 自分の投稿を作成
2. 別のアカウントでログイン
3. 他人の投稿の編集・削除ボタンが表示されないことを確認

#### 確認ポイント
- [ ] 他人の投稿に編集・削除ボタンが表示されない
- [ ] URLを直接入力しても他人の投稿を編集できない
- [ ] 不正なアクセスで適切なエラーが表示される

### 7. セッション管理テスト

#### テスト手順
1. ログイン後、ブラウザの開発者ツールでCookieを確認
2. セッションクッキーの設定を確認

#### 確認ポイント
- [ ] `httpOnly`フラグが設定されている
- [ ] `secure`フラグが設定されている（HTTPS環境）
- [ ] `sameSite`が`lax`に設定されている

### 8. 監査ログテスト

#### 確認方法（管理者権限が必要）
1. MongoDBに接続
2. `auditlogs`コレクションを確認
3. 以下のイベントが記録されているか確認：

#### 確認ポイント
- [ ] ログイン成功/失敗
- [ ] レート制限超過
- [ ] 不正アクセス試行
- [ ] 投稿の作成/更新/削除

### 9. パスワードセキュリティテスト

#### テスト手順
1. 新規登録時に弱いパスワードを試す
2. パスワード変更機能をテスト

#### 確認ポイント
- [ ] 8文字未満のパスワードが拒否される
- [ ] パスワードがハッシュ化されて保存される（DB確認）
- [ ] 古いパスワードの確認が必要

## トラブルシューティング

### よくある問題と対処法

1. **CSRFトークンエラー**
   - ブラウザのキャッシュをクリア
   - Cookieを削除して再ログイン

2. **レート制限の解除**
   - 1分待つか、サーバーを再起動

3. **セキュリティヘッダーが表示されない**
   - ミドルウェアが正しく設定されているか確認
   - `middleware.ts`の設定を確認

## レポート作成

テスト完了後、以下の項目を含むレポートを作成：

1. テスト実施日時
2. テスト環境（OS、ブラウザ、Node.jsバージョン）
3. 各テストの合否
4. 発見された問題と対処法
5. 改善提案

## 定期的な確認事項

- [ ] 依存関係の脆弱性チェック（`npm audit`）
- [ ] ログファイルのサイズ確認
- [ ] 監査ログの保存期間確認（90日）
- [ ] セッションの有効期限確認