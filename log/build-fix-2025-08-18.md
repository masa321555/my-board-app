# Build Fix Log - 2025-08-18

## 概要
Vercelデプロイ時のビルドエラーを修正しました。主な問題はMUI Grid2のインポートエラーとTypeScript型エラーでした。

## 修正内容

### 1. MUI Grid2 インポートエラーの解決
**問題**: `Module '@mui/material/Grid2' not found`
**原因**: MUI v7.2.0ではGrid2が統合され、従来のGridコンポーネントの使用方法が変更されました。
**解決策**: GridコンポーネントをBoxコンポーネントに置き換え、CSS Gridを使用してレイアウトを実装しました。

#### 修正ファイル:
- `/app/dashboard/page.tsx`
- `/app/profile/page.tsx`
- `/app/page.tsx`

#### 変更例:
```typescript
// Before
import { Grid } from '@mui/material';
<Grid container spacing={2}>
  <Grid xs={12} sm={6} md={3}>

// After
import { Box } from '@mui/material';
<Box sx={{ 
  display: 'grid',
  gridTemplateColumns: {
    xs: '1fr',
    sm: 'repeat(2, 1fr)',
    md: 'repeat(4, 1fr)'
  },
  gap: 2
}}>
  <Box>
```

### 2. TypeScript型エラーの修正

#### a. MongoDB mongoose グローバル型定義の競合
**ファイル**: `/lib/mongodb.ts`, `/src/lib/db.ts`
**解決策**: 両ファイルで同じMongooseCache型定義を使用するように統一

#### b. NextAuth設定の型エラー
**ファイル**: `/src/auth.config.ts`
**問題**: `NextAuthConfig`型が存在しない、`authorized`コールバックが不正、`csrfToken`オプションが存在しない
**解決策**: 
- `NextAuthOptions`を使用
- 不正なコールバックとオプションを削除

#### c. emailVerified型の不一致
**ファイル**: `/src/auth.ts`, `/src/lib/auth-options.ts`
**解決策**: `token.emailVerified = !!user.emailVerified`として明示的にboolean型に変換

#### d. authorize関数の戻り値型
**ファイル**: `/src/lib/auth.ts`
**解決策**: roleとemailVerifiedプロパティを戻り値に追加

#### e. cookies() Promise型の問題
**ファイル**: `/src/lib/csrf.ts`
**解決策**: Next.js 15での変更に対応し、`await cookies()`として使用

#### f. nodemailerメソッド名の誤り
**ファイル**: `/src/lib/email/client.ts`
**解決策**: `createTransporter` → `createTransport`

#### g. CSPディレクティブの型定義
**ファイル**: `/src/lib/security-headers.ts`
**解決策**: `Record<string, string[]>`型を明示的に指定

#### h. EmailOptionsインターフェースのエクスポート
**ファイル**: `/src/services/email/emailService.ts`
**解決策**: `export interface EmailOptions`として公開

#### i. zxcvbn型定義の欠如
**解決策**: `npm install --save-dev @types/zxcvbn`を実行

#### j. JWT SignOptions型エラー
**ファイル**: `/src/utils/tokenUtils.ts`
**解決策**: `as jwt.SignOptions`として明示的に型キャスト

### 3. バックアップディレクトリの除外
**ファイル**: `tsconfig.json`, `.eslintignore`
**解決策**: 
- tsconfig.jsonのexcludeに`src/app.backup`を追加
- .eslintignoreファイルを作成（ただしESLint v9では非推奨）

### 4. package-lock.jsonのコミット
- Vercelのデプロイで一貫した依存関係を保証するため、package-lock.jsonをコミット
- vercel.jsonで`npm ci --legacy-peer-deps`を使用するように設定

## 結果
すべての修正後、`npm run build`が成功し、以下の結果を得ました：
- ✓ Compiled successfully
- ✓ Static pages generated (32/32)
- ESLint warningsのみ（エラーなし）

## 今後の推奨事項
1. ESLint warningsの解消（未使用変数の削除など）
2. バックアップディレクトリ（src/app.backup）の削除またはビルドからの完全な除外
3. MUI v7への完全な移行（Grid APIの変更に対応）
4. ESLint設定をv9の新しい形式（eslint.config.js）に移行