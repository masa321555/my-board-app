# 新規登録500エラー修正ログ - 2025年1月18日 11:05:09

## 概要
本番環境（Vercel）で発生していた新規登録時の500エラー「POST /api/auth/register 500 (Internal Server Error)」を修正しました。

## エラーの詳細
- **発生箇所**: 新規登録フォーム送信時
- **エラーメッセージ**: `ユーザー登録に失敗しました`
- **HTTPステータス**: 500 Internal Server Error
- **原因**: Edge Runtimeでnodemailer/bcryptjsが動作しないため

## 実施した修正内容

### 1. Runtime設定の追加（10:35-10:45）
すべての認証関連APIルートに`export const runtime = 'nodejs'`を追加：
- `/app/api/auth/register/route.ts`
- `/app/api/auth/resend-verification/route.ts`
- `/app/api/auth/verify/route.ts`
- `/app/api/auth/reset-password/route.ts`
- `/app/api/auth/forgot-password/route.ts`
- `/app/api/auth/confirm-email/route.ts`

理由：Edge RuntimeではNode.js固有のモジュール（nodemailer、bcryptjs）が動作しないため

### 2. register APIの全面改善（10:45-11:00）
**ファイル**: `/app/api/auth/register/route.ts`

#### a. リクエストバリデーションの改善
```typescript
// リクエストボディの取得（JSON解析エラーをキャッチ）
let body;
try {
  body = await request.json();
} catch (parseError) {
  console.error('リクエストボディのJSON解析エラー:', parseError);
  return NextResponse.json(
    { error: '不正なリクエスト形式です' },
    { status: 400 }
  );
}
```

#### b. DB接続エラーハンドリング
```typescript
// MongoDB接続
try {
  await dbConnect();
  console.log('MongoDB接続成功');
} catch (dbError) {
  console.error('MongoDB接続エラー:', dbError);
  return NextResponse.json(
    { error: 'データベース接続エラーが発生しました' },
    { status: 503 }
  );
}
```

#### c. 重複ユーザーの適切な処理
```typescript
if (existingUser) {
  console.log('既存ユーザーが見つかりました:', validatedData.email);
  return NextResponse.json(
    { error: 'このメールアドレスは既に登録されています' },
    { status: 409 }  // 409 Conflict
  );
}
```

#### d. レスポンスの正規化
```typescript
// ユーザーデータを正規化（_idをidに変換）
const normalizedUser = normalizeUser(user);

return NextResponse.json(
  {
    message,
    user: {
      id: normalizedUser.id,  // _idではなくidを返す
      email: normalizedUser.email,
      name: normalizedUser.name,
      emailVerified: normalizedUser.emailVerified,
    },
    emailSent,
  },
  { status: statusCode }
);
```

#### e. エラーハンドリングの詳細化
- Zodバリデーションエラー: 400 Bad Request
- MongoDB重複キーエラー (E11000): 409 Conflict
- DB接続エラー: 503 Service Unavailable
- メール設定エラー: 502 Bad Gateway
- その他のエラー: 500 Internal Server Error

### 3. メール送信フローの改善（10:50）
- メール送信失敗時でもユーザー登録は成功とする
- メール送信成功時: 201 Created
- メール送信失敗時: 202 Accepted

### 4. TypeScriptエラーの修正（11:00）
- ZodErrorの`errors`プロパティを`issues`に修正

## 技術的な詳細

### Edge Runtime vs Node.js Runtime
- Edge Runtime: 軽量で高速だが、Node.js固有のAPIは使用不可
- Node.js Runtime: 完全なNode.js互換性があるが、コールドスタートが遅い
- 今回はnodemailer/bcryptjsを使用するため、Node.js Runtimeを選択

### HTTPステータスコードの使い分け
- 201 Created: リソース作成成功
- 202 Accepted: リクエスト受理（非同期処理）
- 400 Bad Request: クライアントエラー
- 409 Conflict: リソースの競合
- 502 Bad Gateway: 外部サービスエラー
- 503 Service Unavailable: サービス一時利用不可

## 結果
- ビルドエラー: 解消 ✅
- 500エラー: 解消予定 ✅
- 適切なHTTPステータスコード: 実装 ✅
- エラーメッセージの改善: 完了 ✅

## ブランチ情報
- 作業ブランチ: `fix-register-500-error-20250118`
- マージ先: `main`
- コミットハッシュ: `9239b76`
- マージコミット: `e12d312`

## 今後の課題
- テストコードの追加
  - 単体テスト: バリデーション、重複チェック、メール送信
  - E2Eテスト: 新規登録フロー全体
- メール送信の再送機能の実装
- レート制限の強化

## 作業完了時刻
2025年1月18日 11:05:09