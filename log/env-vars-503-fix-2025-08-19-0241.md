# 環境変数503エラー修正ログ - 2025-08-19 02:41:36

## 発生した問題

### ユーザー報告
- エラーメッセージ: 「必要な環境変数が設定されていません」
- HTTPステータス: 503 Service Unavailable
- エラーコード: CONFIGURATION_ERROR
- ブラウザコンソールにパスワードの実際の値が表示されていた（セキュリティ問題）

### 根本原因
Vercel環境で必要な環境変数（MONGODB_URI、JWT_SECRET/NEXTAUTH_SECRET等）が設定されていなかった

## 実施した修正

### 1. 環境変数チェックの詳細化

#### a. 不足している環境変数の詳細をレスポンスに含める
**ファイル**: `/src/utils/apiResponse.ts`
```typescript
export function missingEnvVarsResponse(missingVars: string[]): NextResponse<ApiErrorResponse> {
  console.error('必要な環境変数が不足しています:', missingVars);
  return errorResponse(
    '必要な環境変数が設定されていません',
    'CONFIGURATION_ERROR',
    503,
    { 
      missing: missingVars,
      message: 'サーバーの設定が不完全です。管理者にお問い合わせください。'
    }
  );
}
```

#### b. DB設定（必須）とメール設定（任意）の分離
**ファイル**: `/app/api/auth/register/route.ts`
- DB関連: MONGODB_URI（必須）
- 認証関連: JWT_SECRETまたはNEXTAUTH_SECRET（どちらか一つが必須）
- メール関連: 任意（設定されていない場合は警告のみ）

### 2. JWT_SECRET/NEXTAUTH_SECRETの互換性対応

**ファイル**: `/src/utils/tokenUtils.ts`
```typescript
private static getJwtSecret(): string {
  const secret = process.env.JWT_SECRET || process.env.NEXTAUTH_SECRET;
  if (!secret) {
    throw new Error('JWT_SECRET or NEXTAUTH_SECRET must be defined');
  }
  return secret;
}
```
どちらか一方の環境変数があれば動作するように修正

### 3. クライアント側のセキュリティ修正

**ファイル**: `/app/auth/register/page.tsx`
- パスワードの実値をコンソールに出力しないように修正
- パスワードの長さのみを表示
- オブジェクトのログ出力時はパスワードを`[REDACTED]`に置換

```typescript
console.log('data.password length:', data.password?.length || 0);
console.log('送信データ（オブジェクト）:', {
  ...dataToSend,
  password: '[REDACTED]',
  confirmPassword: '[REDACTED]'
});
```

### 4. エラーハンドリングの改善

**ファイル**: `/app/auth/register/page.tsx`
CONFIGURATION_ERRORの場合、ユーザーフレンドリーなメッセージを表示：
```typescript
} else if (result.code === 'CONFIGURATION_ERROR') {
  safeSetState(() => {
    setServerError(
      '現在、システムメンテナンス中のため新規登録を一時停止しています。\n' +
      '恐れ入りますが、しばらく時間をおいてから再度お試しください。'
    );
  });
}
```

### 5. ヘルスチェックエンドポイントの作成

**新規ファイル**: `/app/api/health/config/route.ts`
- 環境変数の設定状況を確認できるエンドポイント
- 開発環境では詳細情報、本番環境では最小限の情報を返す
- 各グループ（database、authentication、email、app）ごとに健全性をチェック

### 6. ログ出力の強化

環境変数チェックの詳細なログ出力を追加：
- 各環境変数の存在確認
- グループごとのチェック結果
- 不足している環境変数の詳細

## Vercelでの必要な設定

以下の環境変数をVercelのProject Settingsで設定する必要があります：

### 必須
- `MONGODB_URI`: MongoDBの接続文字列
- `NEXTAUTH_SECRET`: NextAuth.jsのシークレット（JWT_SECRETでも可）

### 任意（メール送信機能を使用する場合）
- `EMAIL_FROM`: 送信元メールアドレス
- SMTPを使用する場合:
  - `SMTP_HOST`
  - `SMTP_PORT`
  - `SMTP_USER`
  - `SMTP_PASS`
- SendGridを使用する場合:
  - `SENDGRID_API_KEY`

### 注意事項
- 環境変数を設定後、再デプロイが必要
- ターゲット（Production/Preview/Development）を正しく設定する
- MongoDBの場合、Atlas側でVercelのIPアドレスを許可する必要がある

## テスト結果
- ビルドテスト: ✅ 成功
- TypeScriptコンパイル: ✅ エラーなし
- mainブランチへのマージ: ✅ 完了
- GitHubへのプッシュ: ✅ 完了

## 今後の推奨事項
1. Vercelの環境変数設定を確認し、必要な変数を追加
2. ヘルスチェックエンドポイント（`/api/health/config`）でデプロイ後の設定確認
3. CI/CDパイプラインに環境変数チェックを組み込む
4. E2Eテストで環境変数エラー時の挙動を検証